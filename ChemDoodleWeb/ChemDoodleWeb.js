//
// ChemDoodle Web Components 2.5.0
//
// http://web.chemdoodle.com
//
// Copyright 2009 iChemLabs, LLC.  All rights reserved.
//
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// As a special exception to the GPL, any HTML file which merely makes
// function calls to this code, and for that purpose includes it by
// reference, shall be deemed a separate work for copyright law purposes.
// If you modify this code, you may extend this exception to your version
// of the code, but you are not obligated to do so. If you do not wish to
// do so, delete this exception statement from your version.
//
// As an additional exception to the GPL, you may distribute this
// packed form of the code without the copy of the GPL license normally
// required, provided you include this license notice and a URL through
// which recipients can access the corresponding unpacked source code.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// Please contact iChemLabs <http://www.ichemlabs.com/contact> for
// alternate licensing options.
//
var default_backgroundColor="#FFFFFF";var default_scale=1;var default_rotateAngle=0;var default_bondLength=20;var default_angstromsPerBondLength=1.25;var default_atoms_display=true;var default_atoms_color="#000000";var default_atoms_font_size=12;var default_atoms_font_families=["Helvetica","Arial","Dialog"];var default_atoms_circles=false;var default_atoms_circleDiameter=10;var default_atoms_circleBorderWidth=1;var default_atoms_useJMOLColors=false;var default_bonds_display=true;var default_bonds_color="#000000";var default_bonds_width=1;var default_bonds_saturationWidth=0.2;var default_bonds_ends="round";var default_bonds_useJMOLColors=false;var default_bonds_saturationAngle=Math.PI/3;var default_bonds_symmetrical=false;var default_bonds_clearOverlaps=false;var default_bonds_overlapClearWidth=0.5;var default_bonds_atomLabelBuffer=0.25;var default_bonds_wedgeThickness=0.22;var default_bonds_hashWidth=1;var default_bonds_hashSpacing=2.5;function VisualSpecifications(){this.backgroundColor=default_backgroundColor;this.scale=default_scale;this.rotateAngle=default_rotateAngle;this.bondLength=default_bondLength;this.angstromsPerBondLength=default_angstromsPerBondLength;this.atoms_display=default_atoms_display;this.atoms_color=default_atoms_color;this.atoms_font_size=default_atoms_font_size;this.atoms_font_families=new Array();for(var a=0;a<default_atoms_font_families.length;a++){this.atoms_font_families[a]=default_atoms_font_families[a]}this.atoms_circles=default_atoms_circles;this.atoms_circleDiameter=default_atoms_circleDiameter;this.atoms_circleBorderWidth=default_atoms_circleBorderWidth;this.atoms_useJMOLColors=default_atoms_useJMOLColors;this.bonds_display=default_bonds_display;this.bonds_color=default_bonds_color;this.bonds_width=default_bonds_width;this.bonds_saturationWidth=default_bonds_saturationWidth;this.bonds_ends=default_bonds_ends;this.bonds_useJMOLColors=default_bonds_useJMOLColors;this.bonds_saturationAngle=default_bonds_saturationAngle;this.bonds_symmetrical=default_bonds_symmetrical;this.bonds_clearOverlaps=default_bonds_clearOverlaps;this.bonds_overlapClearWidth=default_bonds_overlapClearWidth;this.bonds_atomLabelBuffer=default_bonds_atomLabelBuffer;this.bonds_wedgeThickness=default_bonds_wedgeThickness;this.bonds_hashWidth=default_bonds_hashWidth;this.bonds_hashSpacing=default_bonds_hashSpacing}var SHIFT=false;var ALT=false;var CURRENT_OVER=null;jQuery(document).ready(function(){$().keydown(function(a){if(a.keyCode==16){SHIFT=true}else{if(a.keyCode==18){ALT=true}else{if(CURRENT_OVER!=null&&CURRENT_OVER.keydown){CURRENT_OVER.prehandleEvent(a);CURRENT_OVER.keydown(a)}}}});$().keypress(function(a){if(CURRENT_OVER!=null&&CURRENT_OVER.keydown){CURRENT_OVER.prehandleEvent(a);CURRENT_OVER.keydown(a)}});$().keyup(function(a){if(a.keyCode==16){SHIFT=false}else{if(a.keyCode==18){ALT=false}else{if(CURRENT_OVER!=null&&CURRENT_OVER.keyup){CURRENT_OVER.prehandleEvent(a);CURRENT_OVER.keyup(a)}}}})});function Canvas(){this.molecule=null;this.emptyMessage=null;this.image=null;this.repaint=function(){var b=document.getElementById(this.id);if(b.getContext){var a=b.getContext("2d");if(this.image==null){a.fillStyle=this.specs.backgroundColor;a.fillRect(0,0,this.width,this.height)}else{a.drawImage(this.image,0,0)}if(this.molecule!=null){a.save();a.translate(this.width/2,this.height/2);a.rotate(this.specs.rotateAngle);a.scale(this.specs.scale,this.specs.scale);a.translate(-this.width/2,-this.height/2);this.molecule.draw(a,this.specs);a.restore()}else{if(this.emptyMessage!=null){a.fillStyle="#737683";a.textAlign="center";a.textBaseline="middle";a.font="18px Helvetica";a.fillText(this.emptyMessage,this.width/2,this.height/2)}}if(this.drawChildExtras){this.drawChildExtras(a)}}};this.setBackgroundImage=function(b){this.image=new Image();var a=this;this.image.onload=function(){a.repaint()};this.image.src=b};this.loadMolecule=function(a){this.molecule=a;this.center();this.molecule.check();this.repaint()};this.center=function(){var b=document.getElementById(this.id);var e=this.molecule.getCenter3D();var a=new Atom("C",this.width/2,this.height/2,0);a.sub3D(e);for(var c=0;c<this.molecule.atoms.length;c++){this.molecule.atoms[c].add3D(a)}var d=this.molecule.getDimension();this.specs.scale=1;if(d.x>this.width||d.y>this.height){this.specs.scale=Math.min(this.width/d.x,this.height/d.y)*0.9}};this.create=function(d,b,a){this.id=d;this.width=b;this.height=a;if(BrowserDetect.browser=="Explorer"){document.writeln('<div style="border: 1px solid black;" width="'+b+'" height="'+a+'">Please install <a href="http://code.google.com/chrome/chromeframe/">Google Chrome Frame</a>, then restart Internet Explorer.</div>')}else{document.writeln('<canvas class="ChemDoodleWebComponent" id="'+d+'" width="'+b+'" height="'+a+'"></canvas>')}this.specs=new VisualSpecifications();var c=this;$("#"+d).click(function(f){if(c.click){c.prehandleEvent(f);c.click(f)}});$("#"+d).dblclick(function(f){if(c.dblclick){c.prehandleEvent(f);c.dblclick(f)}});$("#"+d).mousedown(function(f){if(c.mousedown){c.prehandleEvent(f);c.mousedown(f)}});$("#"+d).mousemove(function(f){if(c.mousemove){c.prehandleEvent(f);c.mousemove(f)}});$("#"+d).mouseout(function(f){CURRENT_OVER=null;if(c.mouseout){c.prehandleEvent(f);c.mouseout(f)}});$("#"+d).mouseover(function(f){CURRENT_OVER=c;if(c.mouseover){c.prehandleEvent(f);c.mouseover(f)}});$("#"+d).mouseup(function(f){if(c.mouseup){c.prehandleEvent(f);c.mouseup(f)}});$("#"+d).drag(function(f){if(c.drag){c.prehandleEvent(f);c.drag(f)}});$("#"+d).rightclick(function(f){if(c.rightclick){c.prehandleEvent(f);c.rightclick(f)}});$("#"+d).rightmousedown(function(f){if(c.rightmousedown){c.prehandleEvent(f);c.rightmousedown(f)}});$("#"+d).rightmouseup(function(f){if(c.rightmouseup){c.prehandleEvent(f);c.rightmouseup(f)}});$("#"+d).keydown(function(f){alert("got to keydown");if(c.keydown){c.prehandleEvent(f);c.keydown(f)}});$("#"+d).keypress(function(f){alert("got to keypress");if(c.keypress){c.prehandleEvent(f);c.keypress(f)}});$("#"+d).keyup(function(f){alert("got to keyup");if(c.keyup){c.prehandleEvent(f);c.keyup(f)}});$("#"+d).mousewheel(function(f,g){if(c.mousewheel){c.prehandleEvent(f);c.mousewheel(f,g)}})};this.getMolecule=function(){return this.molecule};this.prehandleEvent=function(a){a.preventDefault();var b=$("#"+this.id).offset();a.p=new Point(a.pageX-b.left,a.pageY-b.top)};return true}function AnimatorCanvas(c,b,a){if(c){this.create(c,b,a)}this.handle=null;this.timeout=33;this.startAnimation=function(){this.stopAnimation();var d=this;if(this.nextFrame){this.handle=setInterval(function(){d.nextFrame();d.repaint()},this.timeout)}};this.stopAnimation=function(){if(this.handle!=null){clearInterval(this.handle);this.handle=null}};this.isRunning=function(){return this.handle!=null};return true}AnimatorCanvas.prototype=new Canvas();function DoodleCanvas(d,c,b){if(d){this.create(d,c,b)}this.specs.atoms_useJMOLColors=true;this.specs.atoms_circleDiameter=7;this.specs.atoms_circleBorderWidth=0;this.isHelp=false;this.helpPos=new Point(this.width-20,20);this.tempAtom=null;this.drawChildExtras=function(f){if(this.tempAtom!=null){f.strokeStyle="#00FF00";f.fillStyle="#00FF00";f.lineWidth=1.2;for(var g=0;g<this.molecule.atoms.length;g++){if(this.molecule.atoms[g].isSelected){f.beginPath();f.moveTo(this.molecule.atoms[g].x,this.molecule.atoms[g].y);f.lineTo(this.tempAtom.x,this.tempAtom.y);f.stroke();f.beginPath();f.arc(this.tempAtom.x,this.tempAtom.y,3,0,Math.PI*2,false);f.fill();if(this.tempAtom.isOverlap){f.strokeStyle="#C10000";f.lineWidth=1.2;f.beginPath();f.arc(this.tempAtom.x,this.tempAtom.y,7,0,Math.PI*2,false);f.stroke()}}}}var e=f.createRadialGradient(this.width-20,20,10,this.width-20,20,2);e.addColorStop(0,"#00680F");e.addColorStop(1,"#FFFFFF");f.fillStyle=e;f.beginPath();f.arc(this.helpPos.x,this.helpPos.y,10,0,Math.PI*2,false);f.fill();if(this.isHelp){f.lineWidth=2;f.strokeStyle="black";f.stroke()}f.fillStyle=this.isHelp?"red":"black";f.textAlign="center";f.textBaseline="middle";f.font="14px sans-serif";f.fillText("?",this.helpPos.x,this.helpPos.y)};this.drag=function(o){var l=false;for(var m=0;m<this.molecule.atoms.length;m++){if(this.molecule.atoms[m].isSelected){l=true;if(o.p.distance(this.molecule.atoms[m])<7){var u=this.molecule.atoms[m].x;var q=this.molecule.atoms[m].y;var p=this.molecule.getAngles(this.molecule.atoms[m]);if(p.length==0){u+=this.specs.bondLength*Math.cos(-Math.PI/6);q+=this.specs.bondLength*Math.sin(-Math.PI/6)}else{if(p.length==1){var r=0;var s=null;for(var k=0;k<this.molecule.bonds.length;k++){if(this.molecule.bonds[k].contains(this.molecule.atoms[m])){s=this.molecule.bonds[k]}}if(s.bondOrder>=3){r=p[0]+Math.PI}else{var v=p[0]%Math.PI*2;if(isBetween(v,0,Math.PI/2)||isBetween(v,Math.PI,3*Math.PI/2)){r=p[0]+2*Math.PI/3}else{r=p[0]-2*Math.PI/3}}u+=this.specs.bondLength*Math.cos(r);q-=this.specs.bondLength*Math.sin(r)}else{var f=angleBetweenLargest(p);u+=this.specs.bondLength*Math.cos(f);q-=this.specs.bondLength*Math.sin(f)}}this.tempAtom=new Atom("C",u,q,0)}else{if(ALT&&SHIFT){this.tempAtom=new Atom("C",o.p.x,o.p.y,0)}else{var h=this.molecule.atoms[m].angle(o.p);var g=this.molecule.atoms[m].distance(o.p);if(!SHIFT){g=this.specs.bondLength}if(!ALT){var n=Math.floor((h+Math.PI/12)/(Math.PI/6));h=n*Math.PI/6}this.tempAtom=new Atom("C",this.molecule.atoms[m].x+g*Math.cos(h),this.molecule.atoms[m].y-g*Math.sin(h),0)}}for(var k=0;k<this.molecule.atoms.length;k++){if(this.molecule.atoms[k].distance(this.tempAtom)<5){this.tempAtom.x=this.molecule.atoms[k].x;this.tempAtom.y=this.molecule.atoms[k].y;this.tempAtom.isOverlap=true}}break}}if(!l){var t=new Point(o.p.x,o.p.y);t.sub(this.lastPoint);for(var m=0;m<this.molecule.atoms.length;m++){this.molecule.atoms[m].add(t)}for(var m=0;m<this.molecule.rings.length;m++){this.molecule.rings[m].center=this.molecule.rings[m].getCenter()}}this.lastPoint=o.p;this.repaint()};this.mousedown=function(g){this.lastPoint=g.p;if(this.isHelp){window.open("http://web.chemdoodle.com/DoodlerTutorial.html");this.isHelp=false;this.repaint();return}for(var f=0;f<this.molecule.atoms.length;f++){if(this.molecule.atoms[f].isHover){this.molecule.atoms[f].isHover=false;this.molecule.atoms[f].isSelected=true;this.drag(g);return}}for(var f=0;f<this.molecule.bonds.length;f++){if(this.molecule.bonds[f].isHover){this.molecule.bonds[f].isHover=false;this.molecule.bonds[f].bondOrder+=(this.molecule.bonds[f].bondOrder%1)+1;if(this.molecule.bonds[f].bondOrder>3){this.molecule.bonds[f].bondOrder=1}this.repaint();return}}};this.click=function(k){for(var g=0;g<this.molecule.atoms.length;g++){if(this.tempAtom!=null&&this.molecule.atoms[g].isSelected){if(this.tempAtom.isOverlap){for(var f=0;f<this.molecule.atoms.length;f++){if(this.molecule.atoms[f].distance(this.tempAtom)<5){this.tempAtom=this.molecule.atoms[f]}}}else{this.molecule.atoms[this.molecule.atoms.length]=this.tempAtom}var h=false;for(var f=0;f<this.molecule.bonds.length;f++){if(this.molecule.bonds[f].contains(this.molecule.atoms[g])&&this.molecule.bonds[f].contains(this.tempAtom)){h=true;this.molecule.bonds[f].bondOrder+=(this.molecule.bonds[f].bondOrder%1)+1;if(this.molecule.bonds[f].bondOrder>3){this.molecule.bonds[f].bondOrder=1}}}if(!h){this.molecule.bonds[this.molecule.bonds.length]=new Bond(this.molecule.atoms[g],this.tempAtom,1)}this.molecule.check()}this.molecule.atoms[g].isSelected=false}this.tempAtom=null;this.mousemove(k)};this.mousemove=function(j){if(this.tempAtom!=null){return}var g=Infinity;var h=null;for(var f=0;f<this.molecule.atoms.length;f++){this.molecule.atoms[f].isHover=false;var k=j.p.distance(this.molecule.atoms[f]);if(k<this.specs.bondLength&&k<g){g=k;h=this.molecule.atoms[f]}}for(var f=0;f<this.molecule.bonds.length;f++){this.molecule.bonds[f].isHover=false;var k=j.p.distance(this.molecule.bonds[f].getCenter());if(k<this.specs.bondLength&&k<g){g=k;h=this.molecule.bonds[f]}}if(h!=null){h.isHover=true}this.isHelp=false;if(j.p.distance(this.helpPos)<10){this.isHelp=true}this.repaint()};this.keydown=function(z){if(z.keyCode>=37&&z.keyCode<=40){var l=0;var f=0;switch(z.keyCode){case 37:l=-10;break;case 38:f=-10;break;case 39:l=10;break;case 40:f=10;break}for(var y=0;y<this.molecule.atoms.length;y++){this.molecule.atoms[y].x+=l;this.molecule.atoms[y].y+=f}for(var y=0;y<this.molecule.rings.length;y++){this.molecule.rings[y].center=this.molecule.rings[y].getCenter()}this.repaint()}else{if(z.keyCode==8||z.keyCode==127){for(var y=0;y<this.molecule.atoms.length;y++){if(this.molecule.atoms[y].isHover){for(var x=0;x<this.molecule.atoms.length;x++){this.molecule.atoms[x].visited=false}var t=[];var r=[];this.molecule.atoms[y].visited=true;for(var x=0;x<this.molecule.bonds.length;x++){if(this.molecule.bonds[x].contains(this.molecule.atoms[y])){var m=[];var p=[];var v=new Queue();v.enqueue(this.molecule.bonds[x].getNeighbor(this.molecule.atoms[y]));while(!v.isEmpty()){var B=v.dequeue();if(!B.visited){B.visited=true;m[m.length]=B;for(var w=0;w<this.molecule.bonds.length;w++){if(this.molecule.bonds[w].contains(B)&&!this.molecule.bonds[w].getNeighbor(B).visited){v.enqueue(this.molecule.bonds[w].getNeighbor(B));p[p.length]=this.molecule.bonds[w]}}}}t[t.length]=m;r[r.length]=p}}var h=-1;var n=-1;for(var x=0;x<t.length;x++){if(t[x].length>h){n=x;h=t[x].length}}if(n>-1){this.molecule.atoms=t[n];this.molecule.bonds=r[n];this.molecule.check()}else{var o=new Molecule();o.atoms[0]=new Atom("C",0,0,0);this.loadMolecule(o)}this.repaint();break}}}else{for(var y=0;y<this.molecule.atoms.length;y++){if(this.molecule.atoms[y].isHover){var A=String.fromCharCode(z.keyCode);var g=null;var s=null;var u=false;for(var x=0;x<symbols.length;x++){if(symbols[x]==this.molecule.atoms[y].label){u=true}else{if(symbols[x].charAt(0)==A){if(u&&s==null){s=symbols[x]}else{if(g==null){g=symbols[x]}}}}}if(s!=null){this.molecule.atoms[y].label=s}else{if(g!=null){this.molecule.atoms[y].label=g}}this.molecule.check();this.repaint();break}}}}};var a=new Molecule();a.atoms[0]=new Atom("C",0,0,0);this.loadMolecule(a);return true}DoodleCanvas.prototype=new Canvas();function FileCanvas(d,b,a,c){this.create(d,b,a);form='<br><form name="FileForm" enctype="multipart/form-data" method="POST" action="'+c+'" target="HiddenFileFrame"><input type="file" name="f" /><input type="submit" name="submitbutton" value="Show File" /></form><iframe id="HFF-'+d+'" name="HiddenFileFrame" height="0" width="0" style="display:none;" onLoad="GetMolFromFrame(\'HFF-'+d+"', "+d+')"></iframe>';document.writeln(form);this.emptyMessage="Click below to load file";this.repaint();return true}FileCanvas.prototype=new Canvas();function HyperlinkCanvas(f,d,a,e,b,c){this.urlOrFunction=e;this.color=b?b:"blue";this.size=c?c:2;this.openInNewWindow=true;this.hoverImage=null;if(f){this.create(f,d,a)}this.e=null;this.drawChildExtras=function(g){if(this.e!=null){if(this.hoverImage==null){g.strokeStyle=this.color;g.lineWidth=this.size*2;g.strokeRect(0,0,this.width,this.height)}else{g.drawImage(this.hoverImage,0,0)}}};this.setHoverImage=function(g){this.hoverImage=new Image();this.hoverImage.src=g};this.click=function(g){this.e=null;this.repaint();if(this.urlOrFunction instanceof Function){this.urlOrFunction()}else{if(this.openInNewWindow){window.open(this.urlOrFunction)}else{location.href=this.urlOrFunction}}};this.mouseout=function(g){this.e=null;this.repaint()};this.mouseover=function(g){this.e=g;this.repaint()};return true}HyperlinkCanvas.prototype=new Canvas();function MolGrabberCanvas(d,b,a,c){this.create(d,b,a);form='<br><form name="MolGrabberForm" method="POST" action="'+c+'" target="HiddenMolGrabberFrame" onSubmit="ValidateMolecule(MolGrabberForm); return false;"><input type="text" name="q" value="" /><input type="submit" name="submitbutton" value="Show Molecule" /></form><iframe id="HMGF-'+d+'" name="HiddenMolGrabberFrame" height="0" width="0" style="display:none;" onLoad="GetMolFromFrame(\'HMGF-'+d+"', "+d+')"></iframe>';document.writeln(form);this.emptyMessage="Enter search term below";this.repaint();this.setSearchTerm=function(e){document.MolGrabberForm.q.value=e;document.MolGrabberForm.submit()};return true}MolGrabberCanvas.prototype=new Canvas();function RotatorCanvas(e,c,b,d){if(e){this.create(e,c,b)}this.rotate3D=d;var a=Math.PI/360;this.xIncrement=a;this.yIncrement=a;this.zIncrement=a;this.nextFrame=function(){if(this.molecule==null){this.stopAnimation();return}if(this.rotate3D){var m=$M([[Math.cos(this.zIncrement),-Math.sin(this.zIncrement),0],[Math.sin(this.zIncrement),Math.cos(this.zIncrement),0],[0,0,1]]);var h=$M([[Math.cos(-this.yIncrement),0,Math.sin(-this.yIncrement)],[0,1,0],[-Math.sin(-this.yIncrement),0,Math.cos(-this.yIncrement)]]);var l=$M([[1,0,0],[0,Math.cos(this.xIncrement),-Math.sin(this.xIncrement)],[0,Math.sin(this.xIncrement),Math.cos(this.xIncrement)]]);for(var k=0;k<this.molecule.atoms.length;k++){var g=this.molecule.atoms[k];var f=$V([g.x-this.width/2,g.y-this.height/2,g.z]);var j=m.x(h.x(l.x(f)));g.x=j.e(1)+this.width/2;g.y=j.e(2)+this.height/2;g.z=j.e(3)}for(var k=0;k<this.molecule.rings.length;k++){this.molecule.rings[k].center=this.molecule.rings[k].getCenter()}if(this.specs.atoms_display&&this.specs.atoms_circles){this.molecule.sortAtomsByZ()}if(this.specs.bonds_display&&this.specs.bonds_clearOverlaps){this.molecule.sortBondsByZ()}}else{this.specs.rotateAngle+=this.zIncrement}};return true}RotatorCanvas.prototype=new AnimatorCanvas();function SlideshowCanvas(c,b,a){if(c){this.create(c,b,a)}this.molecules=[];this.curIndex=0;this.timeout=5000;this.alpha=0;this.innerHandle=null;this.phase=0;this.drawChildExtras=function(d){d.fillStyle="rgba("+parseInt(this.specs.backgroundColor.substring(1,3),16)+", "+parseInt(this.specs.backgroundColor.substring(3,5),16)+", "+parseInt(this.specs.backgroundColor.substring(5,7),16)+", "+this.alpha+")";d.fillRect(0,0,this.width,this.height)};this.nextFrame=function(){if(this.molecules.length==0){this.stopAnimation();return}this.phase=0;var e=this;var d=1;this.innerHandle=setInterval(function(){e.alpha=d/15;e.repaint();if(d==15){e.breakInnerHandle()}d++},33)};this.breakInnerHandle=function(){if(this.innerHandle!=null){clearInterval(this.innerHandle);this.innerHandle=null}if(this.phase==0){this.curIndex++;if(this.curIndex>this.molecules.length-1){this.curIndex=0}this.alpha=1;this.loadMolecule(this.molecules[this.curIndex]);this.phase=1;var e=this;var d=1;this.innerHandle=setInterval(function(){e.alpha=(15-d)/15;e.repaint();if(d==15){e.breakInnerHandle()}d++},33)}else{if(this.phase==1){this.alpha=0;this.repaint()}}};this.addMolecule=function(d){if(this.molecules.length==0){this.loadMolecule(d)}this.molecules[this.molecules.length]=d};return true}SlideshowCanvas.prototype=new AnimatorCanvas();var curquat=new Array(4);var lastquat=new Array(4);function TransformCanvas(d,b,a,c){if(d){this.create(d,b,a)}this.lastPoint=null;this.rotate3D=c;this.useQuaternions=false;this.rotationMultMod=1.3;this.mousedown=function(f){this.lastPoint=f.p};this.rightmousedown=function(f){this.lastPoint=f.p};this.drag=function(y){if(ALT){var r=new Point(y.p.x,y.p.y);r.sub(this.lastPoint);for(var w=0;w<this.molecule.atoms.length;w++){this.molecule.atoms[w].add(r)}this.lastPoint=y.p;this.repaint()}else{if(this.rotate3D==true){var o=Math.max(this.width/4,this.height/4);if(this.useQuaternions){trackball(curquat,0,0,0,0);trackball(lastquat,(this.lastPoint.x-this.width/2)/o,-(this.lastPoint.y-this.height/2)/o,(y.p.x-this.width/2)/o,-(y.p.y-this.height/2)/o);add_quats(lastquat,curquat,curquat);var v=new Array(16);build_rotmatrix(v,curquat);for(var w=0;w<this.molecule.atoms.length;w++){var A=this.molecule.atoms[w];var p=-(A.x-this.width/2);var n=-(A.y-this.height/2);var l=-A.z;A.x=-(p*v[0]+n*v[1]+l*v[2])+this.width/2;A.y=-(p*v[4]+n*v[5]+l*v[6])+this.height/2;A.z=-(p*v[8]+n*v[9]+l*v[10])}}else{var h=y.p.x-this.lastPoint.x;var g=y.p.y-this.lastPoint.y;var f=h/o*this.rotationMultMod;var u=-g/o*this.rotationMultMod;var m=$M([[Math.cos(f),0,Math.sin(f)],[0,1,0],[-Math.sin(f),0,Math.cos(f)]]);var k=$M([[1,0,0],[0,Math.cos(u),-Math.sin(u)],[0,Math.sin(u),Math.cos(u)]]);for(var w=0;w<this.molecule.atoms.length;w++){var A=this.molecule.atoms[w];var s=$V([A.x-this.width/2,A.y-this.height/2,A.z]);var x=m.x(k.x(s));A.x=x.e(1)+this.width/2;A.y=x.e(2)+this.height/2;A.z=x.e(3)}}for(var w=0;w<this.molecule.rings.length;w++){this.molecule.rings[w].center=this.molecule.rings[w].getCenter()}this.lastPoint=y.p;if(this.specs.atoms_display&&this.specs.atoms_circles){this.molecule.sortAtomsByZ()}if(this.specs.bonds_display&&this.specs.bonds_clearOverlaps){this.molecule.sortBondsByZ()}this.repaint()}else{var z=new Point(this.width/2,this.height/2);var q=z.angle(this.lastPoint);var j=z.angle(y.p);this.specs.rotateAngle-=(j-q);this.lastPoint=y.p;this.repaint()}}};this.mousewheel=function(f,g){this.specs.scale+=g/100;this.repaint()};return true}TransformCanvas.prototype=new Canvas();function ViewerCanvas(c,b,a){if(c){this.create(c,b,a)}return true}ViewerCanvas.prototype=new Canvas();var LEEWAY=1.1;function getPointsPerAngstrom(){return default_bondLength/default_angstromsPerBondLength}function deduceCovalentBonds(a){var e=getPointsPerAngstrom();for(var d=0;d<a.atoms.length;d++){for(var c=d+1;c<a.atoms.length;c++){var f=a.atoms[d];var b=a.atoms[c];if(f.distance3D(b)<(covalentRadii[f.label]+covalentRadii[b.label])*e*LEEWAY){a.bonds[a.bonds.length]=new Bond(f,b,1)}}}}function removeHydrogens(a){var b=[];var d=[];for(var c=0;c<a.bonds.length;c++){if(a.bonds[c].a1.label!="H"&&a.bonds[c].a2.label!="H"){d[d.length]=a.bonds[c]}}for(var c=0;c<a.atoms.length;c++){if(a.atoms[c].label!="H"){b[b.length]=a.atoms[c]}}a.atoms=b;a.bonds=d}function Link(a){this.data=a;this.next=null;this.reverse=function(b){if(this.next!=null){this.next.reverse(this)}this.next=b};this.getDataArray=function(b){b[b.length]=a;if(this.next!=null){this.next.getDataArray(b)}};this.count=function(){if(this.next==null){return 1}else{return 1+this.next.count()}}}function PGraphEdge(b,a){if(b!=null){this.head=new Link(b);this.head.next=new Link(a)}this.getLast=function(){var c=this.head;while(c.next!=null){c=c.next}return c};this.getCopy=function(){var e=new PGraphEdge();var d=this.head;var c=new Link(d.data);e.head=c;while(d.next!=null){d=d.next;c.next=new Link(d.data);c=c.next}return e};this.merge=function(c){var d=this.getCopy();var f=this.head.data;if(c.head.data!=f&&c.getLast().data!=f){f=this.getLast().data}var e=c.getCopy();if(d.head.data==f){d.reverse()}if(c.head.data!=f){e.reverse()}e.head=e.head.next;d.getLast().next=e.head;return d};this.connectsTo=function(c){return this.head.data==c||this.getLast().data==c};this.isCycle=function(){return this.head.data==this.getLast().data};this.size=function(){return this.head.count()};this.reverse=function(){var c=this.getLast();this.head.reverse(null);this.head=c}}function indexOf(c,b){for(var a=0;a<c.length;a++){if(c[a]==b){return a}}return -1}function getRingsSSSR(l){var r=[];var A=[];for(var x=0;x<l.bonds.length;x++){r[r.length]=new PGraphEdge(indexOf(l.atoms,l.bonds[x].a1),indexOf(l.atoms,l.bonds[x].a2))}while(r.length>0){var z=new Array(l.atoms.length);for(var x=0;x<z.length;x++){z[x]=0}for(var x=0;x<r.length;x++){z[r[x].head.data]++;z[r[x].getLast().data]++}var c=-1;var t=Infinity;for(var x=0;x<z.length;x++){if(z[x]>0&&z[x]<t){t=z[x];c=x}}var d=[];var y=[];for(var x=0;x<r.length;x++){if(r[x].connectsTo(c)){d[d.length]=r[x]}else{y[y.length]=r[x]}}r=y;for(var x=0;x<d.length;x++){for(var w=x+1;w<d.length;w++){var s=d[x];var h=d[w];var p=s.merge(h);var a=false;var q=p.head.next;while(!a&&q!=null){var m=q.next;while(!a&&m!=null){if(m.data==q.data){a=true}m=m.next}q=q.next}if(!a){if(p.isCycle()){A[A.length]=p}else{r[r.length]=p}}}}}var f=new Array(A.length);var b=[];for(var x=0;x<A.length;x++){b[x]=A[x].size();f[x]=false}var o=l.bonds.length-l.atoms.length+(l.atoms.length>0?1:0);var v=new Array(o);for(var x=0;x<o;x++){var t=Infinity;var e=-1;for(var w=0;w<b.length;w++){if(!f[w]&&b[w]<t){t=b[w];e=w}}v[x]=[];if(e!=-1){A[e].head.getDataArray(v[x]);f[e]=true}}var n=new Array(v.length);for(var x=0;x<v.length;x++){var g=new Ring();for(var w=0;w<v[x].length-1;w++){g.atoms[w]=l.atoms[v[x][w]]}for(var w=0;w<g.atoms.length-1;w++){for(var u=0;u<l.bonds.length;u++){if(l.bonds[u].contains(g.atoms[w])&&l.bonds[u].contains(g.atoms[w+1])){g.bonds[g.bonds.length]=l.bonds[u];break}}}for(var u=0;u<l.bonds.length;u++){if(l.bonds[u].contains(g.atoms[0])&&l.bonds[u].contains(g.atoms[g.atoms.length-1])){g.bonds[g.bonds.length]=l.bonds[u];break}}n[x]=g}return n}function copy(a){for(var c=0;c<a.atoms.length;c++){a.atoms[c].metaID=c}var b=new Molecule();for(var c=0;c<a.atoms.length;c++){b.atoms[c]=new Atom(a.atoms[c].label,a.atoms[c].x,a.atoms[c].y,a.atoms[c].z)}for(var c=0;c<a.bonds.length;c++){b.bonds[c]=new Bond(b.atoms[a.bonds[c].a1.metaID],b.atoms[a.bonds[c].a2.metaID],a.bonds[c].bondOrder)}return b}function Point(a,b){this.x=a?a:0;this.y=b?b:0;this.sub=function(c){this.x-=c.x;this.y-=c.y};this.add=function(c){this.x+=c.x;this.y+=c.y};this.distance=function(c){return Math.sqrt(Math.pow(c.x-this.x,2)+Math.pow(c.y-this.y,2))};this.angleForStupidCanvasArcs=function(e){var d=e.x-this.x;var c=e.y-this.y;var f=0;if(d==0){if(c==0){f=0}else{if(c>0){f=Math.PI/2}else{f=3*Math.PI/2}}}else{if(c==0){if(d>0){f=0}else{f=Math.PI}}else{if(d<0){f=Math.atan(c/d)+Math.PI}else{if(c<0){f=Math.atan(c/d)+2*Math.PI}else{f=Math.atan(c/d)}}}}while(f<0){f+=Math.PI*2}f=f%(Math.PI*2);return f};this.angle=function(e){var d=e.x-this.x;var c=this.y-e.y;var f=0;if(d==0){if(c==0){f=0}else{if(c>0){f=Math.PI/2}else{f=3*Math.PI/2}}}else{if(c==0){if(d>0){f=0}else{f=Math.PI}}else{if(d<0){f=Math.atan(c/d)+Math.PI}else{if(c<0){f=Math.atan(c/d)+2*Math.PI}else{f=Math.atan(c/d)}}}}while(f<0){f+=Math.PI*2}f=f%(Math.PI*2);return f};return true}function Ring(){this.atoms=[];this.bonds=[];this.center=null;this.setupBonds=function(){for(var a=0;a<this.bonds.length;a++){this.bonds[a].ring=this}this.center=this.getCenter()};this.getCenter=function(){var a=minY=Infinity;var c=maxY=-Infinity;for(var b=0;b<this.atoms.length;b++){a=Math.min(this.atoms[b].x,a);minY=Math.min(this.atoms[b].y,minY);c=Math.max(this.atoms[b].x,c);maxY=Math.max(this.atoms[b].y,maxY)}return new Point((c+a)/2,(maxY+minY)/2)}}var symbols=["H","He","Li","Be","B","C","N","O","F","Ne","Na","Mg","Al","Si","P","S","Cl","Ar","K","Ca","Sc","Ti","V","Cr","Mn","Fe","Co","Ni","Cu","Zn","Ga","Ge","As","Se","Br","Kr","Rb","Sr","Y","Zr","Nb","Mo","Tc","Ru","Rh","Pd","Ag","Cd","In","Sn","Sb","Te","I","Xe","Cs","Ba","La","Ce","Pr","Nd","Pm","Sm","Eu","Gd","Tb","Dy","Ho","Er","Tm","Yb","Lu","Hf","Ta","W","Re","Os","Ir","Pt","Au","Hg","Tl","Pb","Bi","Po","At","Rn","Fr","Ra","Ac","Th","Pa","U","Np","Pu","Am","Cm","Bk","Cf","Es","Fm","Md","No","Lr","Rf","Db","Sg","Bh","Hs","Mt","Ds","Rg","Uub","Uut","Uuq","Uup","Uuh","Uus","Uuo"];var jmolColors=new Array();jmolColors.H="#ffffff";jmolColors.He="#d9ffff";jmolColors.Li="#cc80ff";jmolColors.Be="#c2ff00";jmolColors.B="#ffb5b5";jmolColors.C="#909090";jmolColors.N="#3050f8";jmolColors.O="#ff0d0d";jmolColors.F="#90e050";jmolColors.Ne="#b3e3f5";jmolColors.Na="#ab5cf2";jmolColors.Mg="#8aff00";jmolColors.Al="#bfa6a6";jmolColors.Si="#f0c8a0";jmolColors.P="#ff8000";jmolColors.S="#ffff30";jmolColors.Cl="#1ff01f";jmolColors.Ar="#80d1e3";jmolColors.K="#8f40d4";jmolColors.Ca="#3dff00";jmolColors.Sc="#e6e6e6";jmolColors.Ti="#bfc2c7";jmolColors.V="#a6a6ab";jmolColors.Cr="#8a99c7";jmolColors.Mn="#9c7ac7";jmolColors.Fe="#e06633";jmolColors.Co="#f090a0";jmolColors.Ni="#50d050";jmolColors.Cu="#c88033";jmolColors.Zn="#7d80b0";jmolColors.Ga="#c28f8f";jmolColors.Ge="#668f8f";jmolColors.As="#bd80e3";jmolColors.Se="#ffa100";jmolColors.Br="#a62929";jmolColors.Kr="#5cb8d1";jmolColors.Rb="#702eb0";jmolColors.Sr="#ff00";jmolColors.Y="#94ffff";jmolColors.Zr="#94e0e0";jmolColors.Nb="#73c2c9";jmolColors.Mo="#54b5b5";jmolColors.Tc="#3b9e9e";jmolColors.Ru="#248f8f";jmolColors.Rh="#a7d8c";jmolColors.Pd="#6985";jmolColors.Ag="#c0c0c0";jmolColors.Cd="#ffd98f";jmolColors.In="#a67573";jmolColors.Sn="#668080";jmolColors.Sb="#9e63b5";jmolColors.Te="#d47a00";jmolColors.I="#940094";jmolColors.Xe="#429eb0";jmolColors.Cs="#57178f";jmolColors.Ba="#c900";jmolColors.La="#70d4ff";jmolColors.Ce="#ffffc7";jmolColors.Pr="#d9ffc7";jmolColors.Nd="#c7ffc7";jmolColors.Pm="#a3ffc7";jmolColors.Sm="#8fffc7";jmolColors.Eu="#61ffc7";jmolColors.Gd="#45ffc7";jmolColors.Tb="#30ffc7";jmolColors.Dy="#1fffc7";jmolColors.Ho="#ff9c";jmolColors.Er="#e675";jmolColors.Tm="#d452";jmolColors.Yb="#bf38";jmolColors.Lu="#ab24";jmolColors.Hf="#4dc2ff";jmolColors.Ta="#4da6ff";jmolColors.W="#2194d6";jmolColors.Re="#267dab";jmolColors.Os="#266696";jmolColors.Ir="#175487";jmolColors.Pt="#d0d0e0";jmolColors.Au="#ffd123";jmolColors.Hg="#b8b8d0";jmolColors.Tl="#a6544d";jmolColors.Pb="#575961";jmolColors.Bi="#9e4fb5";jmolColors.Po="#ab5c00";jmolColors.At="#754f45";jmolColors.Rn="#428296";jmolColors.Fr="#420066";jmolColors.Ra="#7d00";jmolColors.Ac="#70abfa";jmolColors.Th="#baff";jmolColors.Pa="#a1ff";jmolColors.U="#8fff";jmolColors.Np="#80ff";jmolColors.Pu="#6bff";jmolColors.Am="#545cf2";jmolColors.Cm="#785ce3";jmolColors.Bk="#8a4fe3";jmolColors.Cf="#a136d4";jmolColors.Es="#b31fd4";jmolColors.Fm="#b31fba";jmolColors.Md="#b30da6";jmolColors.No="#bd0d87";jmolColors.Lr="#c70066";jmolColors.Rf="#cc0059";jmolColors.Db="#d1004f";jmolColors.Sg="#d90045";jmolColors.Bh="#e00038";jmolColors.Hs="#e6002e";jmolColors.Mt="#eb0026";jmolColors.Ds="#000000";jmolColors.Rg="#000000";jmolColors.Uub="#000000";jmolColors.Uut="#000000";jmolColors.Uuq="#000000";jmolColors.Uup="#000000";jmolColors.Uuh="#000000";jmolColors.Uus="#000000";jmolColors.Uuo="#000000";var covalentRadii=new Array();covalentRadii.H=0.31;covalentRadii.He=0.28;covalentRadii.Li=1.28;covalentRadii.Be=0.96;covalentRadii.B=0.84;covalentRadii.C=0.76;covalentRadii.N=0.71;covalentRadii.O=0.66;covalentRadii.F=0.57;covalentRadii.Ne=0.58;covalentRadii.Na=1.66;covalentRadii.Mg=1.41;covalentRadii.Al=1.21;covalentRadii.Si=1.11;covalentRadii.P=1.07;covalentRadii.S=1.05;covalentRadii.Cl=1.02;covalentRadii.Ar=1.06;covalentRadii.K=2.03;covalentRadii.Ca=1.76;covalentRadii.Sc=1.7;covalentRadii.Ti=1.6;covalentRadii.V=1.53;covalentRadii.Cr=1.39;covalentRadii.Mn=1.39;covalentRadii.Fe=1.32;covalentRadii.Co=1.26;covalentRadii.Ni=1.24;covalentRadii.Cu=1.32;covalentRadii.Zn=1.22;covalentRadii.Ga=1.22;covalentRadii.Ge=1.2;covalentRadii.As=1.19;covalentRadii.Se=1.2;covalentRadii.Br=1.2;covalentRadii.Kr=1.16;covalentRadii.Rb=2.2;covalentRadii.Sr=1.95;covalentRadii.Y=1.9;covalentRadii.Zr=1.75;covalentRadii.Nb=1.64;covalentRadii.Mo=1.54;covalentRadii.Tc=1.47;covalentRadii.Ru=1.46;covalentRadii.Rh=1.42;covalentRadii.Pd=1.39;covalentRadii.Ag=1.45;covalentRadii.Cd=1.44;covalentRadii.In=1.42;covalentRadii.Sn=1.39;covalentRadii.Sb=1.39;covalentRadii.Te=1.38;covalentRadii.I=1.39;covalentRadii.Xe=1.4;covalentRadii.Cs=2.44;covalentRadii.Ba=2.15;covalentRadii.La=2.07;covalentRadii.Ce=2.04;covalentRadii.Pr=2.03;covalentRadii.Nd=2.01;covalentRadii.Pm=1.99;covalentRadii.Sm=1.98;covalentRadii.Eu=1.98;covalentRadii.Gd=1.96;covalentRadii.Tb=1.94;covalentRadii.Dy=1.92;covalentRadii.Ho=1.92;covalentRadii.Er=1.89;covalentRadii.Tm=1.9;covalentRadii.Yb=1.87;covalentRadii.Lu=1.87;covalentRadii.Hf=1.75;covalentRadii.Ta=1.7;covalentRadii.W=1.62;covalentRadii.Re=1.51;covalentRadii.Os=1.44;covalentRadii.Ir=1.41;covalentRadii.Pt=1.36;covalentRadii.Au=1.36;covalentRadii.Hg=1.32;covalentRadii.Tl=1.45;covalentRadii.Pb=1.46;covalentRadii.Bi=1.48;covalentRadii.Po=1.4;covalentRadii.At=1.5;covalentRadii.Rn=1.5;covalentRadii.Fr=2.6;covalentRadii.Ra=2.21;covalentRadii.Ac=2.15;covalentRadii.Th=2.06;covalentRadii.Pa=2;covalentRadii.U=1.96;covalentRadii.Np=1.9;covalentRadii.Pu=1.87;covalentRadii.Am=1.8;covalentRadii.Cm=1.69;covalentRadii.Bk=0;covalentRadii.Cf=0;covalentRadii.Es=0;covalentRadii.Fm=0;covalentRadii.Md=0;covalentRadii.No=0;covalentRadii.Lr=0;covalentRadii.Rf=0;covalentRadii.Db=0;covalentRadii.Sg=0;covalentRadii.Bh=0;covalentRadii.Hs=0;covalentRadii.Mt=0;covalentRadii.Ds=0;covalentRadii.Rg=0;covalentRadii.Uub=0;covalentRadii.Uut=0;covalentRadii.Uuq=0;covalentRadii.Uup=0;covalentRadii.Uuh=0;covalentRadii.Uus=0;covalentRadii.Uuo=0;function Atom(b,a,d,c){this.x=a?a:0;this.y=d?d:0;this.z=c?c:0;this.label=b?b.replace(/\s/g,""):"C";if(!covalentRadii[this.label]){this.label="C"}this.isLone=false;this.isHover=false;this.isSelected=false;this.isOverlap=false;this.add3D=function(e){this.x+=e.x;this.y+=e.y;this.z+=e.z};this.sub3D=function(e){this.x-=e.x;this.y-=e.y;this.z-=e.z};this.distance3D=function(e){return Math.sqrt(Math.pow(e.x-this.x,2)+Math.pow(e.y-this.y,2)+Math.pow(e.z-this.z,2))};this.draw=function(e,j){e.fillStyle=j.atoms_color;if(j.atoms_useJMOLColors){e.fillStyle=jmolColors[this.label]}if(this.isLone||j.atoms_circles){e.beginPath();e.arc(this.x,this.y,j.atoms_circleDiameter/2,0,Math.PI*2,false);e.fill();if(j.atoms_circleBorderWidth>0){e.lineWidth=j.atoms_circleBorderWidth;e.strokeStyle="black";e.stroke(this.x,this.y,0,Math.PI*2,j.atoms_circleDiameter/2)}}else{if(this.isLabelVisible()){var f=j.atoms_font_size+"px ";for(var g=0;g<j.atoms_font_families.length;g++){var h=",";if(g==j.atoms_font_families.length-1){h=""}f=f+j.atoms_font_families[g]+h}e.font=f;e.textAlign="center";e.textBaseline="middle";e.fillText(this.label,this.x,this.y)}}if(this.isHover||this.isSelected||this.isOverlap){e.strokeStyle=this.isHover?"#885110":"#0060B2";e.lineWidth=1.2;e.beginPath();e.arc(this.x,this.y,7,0,Math.PI*2,false);e.stroke()}};this.isLabelVisible=function(){return this.label!="C"};return true}Atom.prototype=new Point(0,0);var BOND_STEREO_NONE="BOND_STEREO_NONE";var BOND_STEREO_PROTRUDING="BOND_STEREO_PROTRUDING";var BOND_STEREO_RECESSED="BOND_STEREO_RECESSED";var BOND_STEREO_AMBIGUOUS="BOND_STEREO_AMBIGUOUS";function Bond(c,b,a){this.a1=c;this.a2=b;this.bondOrder=a?a:1;this.stereo=BOND_STEREO_NONE;this.isHover=false;this.ring=null;this.getCenter=function(){return new Point((this.a1.x+this.a2.x)/2,(this.a1.y+this.a2.y)/2)};this.contains=function(d){return d==this.a1||d==this.a2};this.getNeighbor=function(d){if(d==this.a1){return this.a2}else{if(d==this.a2){return this.a1}}return null};this.draw=function(r,k){var n=this.a1.x;var m=this.a2.x;var O=this.a1.y;var M=this.a2.y;var B=m-n;var A=M-O;if(k.atoms_display&&!k.atoms_circles&&c.isLabelVisible()){n+=B*k.bonds_atomLabelBuffer;O+=A*k.bonds_atomLabelBuffer}if(k.atoms_display&&!k.atoms_circles&&b.isLabelVisible()){m-=B*k.bonds_atomLabelBuffer;M-=A*k.bonds_atomLabelBuffer}if(k.bonds_clearOverlaps&&this.a1.distance(this.a2)>k.bondLength*0.8){var x=n+B*0.15;var l=O+A*0.15;var D=m-B*0.15;var s=M-A*0.15;r.strokeStyle=k.backgroundColor;r.lineWidth=k.bonds_width+k.bonds_overlapClearWidth*2;r.lineCap="round";r.beginPath();r.moveTo(x,l);r.lineTo(D,s);r.closePath();r.stroke()}r.strokeStyle=k.bonds_color;r.fillStyle=k.bonds_color;r.lineWidth=k.bonds_width;r.lineCap=k.bonds_ends;if(k.bonds_useJMOLColors){var j=r.createLinearGradient(n,O,m,M);j.addColorStop(0,jmolColors[this.a1.label]);j.addColorStop(1,jmolColors[this.a2.label]);r.strokeStyle=j}switch(this.bondOrder){case 1:if(this.stereo==BOND_STEREO_PROTRUDING||this.stereo==BOND_STEREO_RECESSED){var N=this.a1.distance(this.a2)*k.bonds_wedgeThickness/2;var y=this.a1.angle(this.a2)+Math.PI/2;var F=m+Math.cos(y)*N;var u=M-Math.sin(y)*N;var E=m-Math.cos(y)*N;var t=M+Math.sin(y)*N;r.beginPath();r.moveTo(n,O);r.lineTo(F,u);r.lineTo(E,t);r.closePath();if(this.stereo==BOND_STEREO_PROTRUDING){r.fill()}else{r.save();r.clip();r.beginPath();r.moveTo(n,O);r.lineWidth=N*2;r.lineCap="butt";var z=0;var g=this.a1.distance(this.a2);var K=false;var i=n;var h=O;while(z<g){if(K){var d=k.bonds_hashSpacing/g;i+=d*B;h+=d*A;r.moveTo(i,h);z+=k.bonds_hashSpacing}else{var d=k.bonds_hashWidth/g;i+=d*B;h+=d*A;r.lineTo(i,h);z+=k.bonds_hashWidth}K=!K}r.stroke();r.restore()}}else{r.beginPath();r.moveTo(n,O);r.lineTo(m,M);r.stroke()}break;case 1.5:r.beginPath();r.moveTo(n,O);r.lineTo(m,M);r.stroke();break;case 2:if(this.stereo==BOND_STEREO_AMBIGUOUS){var N=this.a1.distance(this.a2)*k.bonds_saturationWidth/2;var y=this.a1.angle(this.a2)+Math.PI/2;var I=n-Math.cos(y)*N;var w=O+Math.sin(y)*N;var H=n+Math.cos(y)*N;var v=O-Math.sin(y)*N;var F=m+Math.cos(y)*N;var u=M-Math.sin(y)*N;var E=m-Math.cos(y)*N;var t=M+Math.sin(y)*N;r.beginPath();r.moveTo(I,w);r.lineTo(F,u);r.moveTo(H,v);r.lineTo(E,t);r.stroke()}else{if(!k.bonds_symmetrical&&(this.ring!=null||this.a1.label=="C"&&this.a2.label=="C")){r.beginPath();r.moveTo(n,O);r.lineTo(m,M);var C=0;var g=this.a1.distance(this.a2);var o=this.a1.angle(this.a2);var y=o+Math.PI/2;var N=g*k.bonds_saturationWidth;var G=k.bonds_saturationAngle;if(G<Math.PI/2){C=-(N/Math.tan(G))}if(Math.abs(C)<g/2){var q=n-Math.cos(o)*C;var p=m+Math.cos(o)*C;var f=O+Math.sin(o)*C;var e=M-Math.sin(o)*C;var I=q-Math.cos(y)*N;var w=f+Math.sin(y)*N;var H=q+Math.cos(y)*N;var v=f-Math.sin(y)*N;var F=p-Math.cos(y)*N;var u=e+Math.sin(y)*N;var E=p+Math.cos(y)*N;var t=e-Math.sin(y)*N;var L=this.ring==null||(this.ring.center.angle(c)>this.ring.center.angle(b)&&!(this.ring.center.angle(c)-this.ring.center.angle(b)>Math.PI)||(this.ring.center.angle(c)-this.ring.center.angle(b)<-Math.PI));if(L){r.moveTo(I,w);r.lineTo(F,u)}else{r.moveTo(H,v);r.lineTo(E,t)}r.stroke()}}else{var N=this.a1.distance(this.a2)*k.bonds_saturationWidth/2;var y=this.a1.angle(this.a2)+Math.PI/2;var I=n-Math.cos(y)*N;var w=O+Math.sin(y)*N;var H=n+Math.cos(y)*N;var v=O-Math.sin(y)*N;var F=m+Math.cos(y)*N;var u=M-Math.sin(y)*N;var E=m-Math.cos(y)*N;var t=M+Math.sin(y)*N;r.beginPath();r.moveTo(I,w);r.lineTo(E,t);r.moveTo(H,v);r.lineTo(F,u);r.stroke()}}break;case 3:var N=this.a1.distance(this.a2)*k.bonds_saturationWidth;var y=this.a1.angle(this.a2)+Math.PI/2;var I=n-Math.cos(y)*N;var w=O+Math.sin(y)*N;var H=n+Math.cos(y)*N;var v=O-Math.sin(y)*N;var F=m+Math.cos(y)*N;var u=M-Math.sin(y)*N;var E=m-Math.cos(y)*N;var t=M+Math.sin(y)*N;r.beginPath();r.moveTo(I,w);r.lineTo(E,t);r.moveTo(H,v);r.lineTo(F,u);r.moveTo(n,O);r.lineTo(m,M);r.stroke();break}if(this.isHover){var o=this.a1.angleForStupidCanvasArcs(this.a2)+Math.PI/2;r.strokeStyle="#885110";r.lineWidth=1.2;r.beginPath();var J=o+Math.PI;J=J%(Math.PI*2);r.arc(this.a1.x,this.a1.y,6,o,J,false);r.stroke();r.beginPath();o+=Math.PI;J=o+Math.PI;J=J%(Math.PI*2);r.arc(this.a2.x,this.a2.y,7,o,J,false);r.stroke()}};return true}function Molecule(){this.atoms=[];this.bonds=[];this.rings=[];this.findRings=true;this.draw=function(a,c){if(c.bonds_display==true){for(var b=0;b<this.bonds.length;b++){this.bonds[b].draw(a,c)}}if(c.atoms_display==true){for(var b=0;b<this.atoms.length;b++){this.atoms[b].draw(a,c)}}};this.getCenter3D=function(){if(this.atoms.length==1){return new Atom("C",this.atoms[0].x,this.atoms[0].y,this.atoms[0].z)}var a=minY=minZ=Infinity;var c=maxY=maxZ=-Infinity;for(var b=0;b<this.atoms.length;b++){a=Math.min(this.atoms[b].x,a);minY=Math.min(this.atoms[b].y,minY);minZ=Math.min(this.atoms[b].z,minZ);c=Math.max(this.atoms[b].x,c);maxY=Math.max(this.atoms[b].y,maxY);maxZ=Math.max(this.atoms[b].z,maxZ)}return new Atom("C",(c+a)/2,(maxY+minY)/2,(maxZ+minZ)/2)};this.getCenter=function(){if(this.atoms.length==1){return new Point(this.atoms[0].x,this.atoms[0].y)}var a=minY=Infinity;var c=maxY=-Infinity;for(var b=0;b<this.atoms.length;b++){a=Math.min(this.atoms[b].x,a);minY=Math.min(this.atoms[b].y,minY);c=Math.max(this.atoms[b].x,c);maxY=Math.max(this.atoms[b].y,maxY)}return new Point((c+a)/2,(maxY+minY)/2)};this.getDimension=function(){if(this.atoms.length==1){return new Point(0,0)}var a=minY=Infinity;var c=maxY=-Infinity;for(var b=0;b<this.atoms.length;b++){a=Math.min(this.atoms[b].x,a);minY=Math.min(this.atoms[b].y,minY);c=Math.max(this.atoms[b].x,c);maxY=Math.max(this.atoms[b].y,maxY)}return new Point(c-a,maxY-minY)};this.check=function(){for(var c=0;c<this.atoms.length;c++){this.atoms[c].isLone=false;if(this.atoms[c].label=="C"){var a=0;for(var b=0;b<this.bonds.length;b++){if(this.bonds[b].a1==this.atoms[c]||this.bonds[b].a2==this.atoms[c]){a++}}if(a==0){this.atoms[c].isLone=true}}}if(this.findRings){this.rings=getRingsSSSR(this);for(var c=0;c<this.rings.length;c++){this.rings[c].setupBonds()}}this.sortAtomsByZ();this.sortBondsByZ()};this.getAngles=function(b){var d=[];for(var c=0;c<this.bonds.length;c++){if(this.bonds[c].contains(b)){d[d.length]=b.angle(this.bonds[c].getNeighbor(b))}}d.sort();return d};this.sortAtomsByZ=function(){for(var b=1;b<this.atoms.length;b++){var a=b;while(a>0&&this.atoms[a].z<this.atoms[a-1].z){var c=this.atoms[a];this.atoms[a]=this.atoms[a-1];this.atoms[a-1]=c;a--}}};this.sortBondsByZ=function(){for(var b=1;b<this.bonds.length;b++){var a=b;while(a>0&&(this.bonds[a].a1.z+this.bonds[a].a2.z)<(this.bonds[a-1].a1.z+this.bonds[a-1].a2.z)){var c=this.bonds[a];this.bonds[a]=this.bonds[a-1];this.bonds[a-1]=c;a--}}};return true}function ValidateMolecule(a){if(a.q.value.match(/^$|^ +$/)){alert("You must enter a molecule value.");return false}a.submit();return true}function GetMolFromFrame(b,a){if(!a){return}var c=document.getElementById(b).contentDocument.body.innerHTML;if(c.match("^ChemDoodle Web Components Query Error.")){alert(c)}else{var c=readMOL(c);removeHydrogens(c);a.loadMolecule(c)}}function GetPdbFromFrameDEMO(b,a){if(!a){return}var c=document.getElementById(b).contentDocument.body.innerHTML;if(c.match("^ChemDoodle Web Components Query Error.")){alert(c)}else{a.loadMolecule(readPDB(c))}}function readMOL(f){var e=new Molecule();if(f==null||f.length==0){return e}var a=f.split("\n");var k=a[3];var d=parseInt(parseInt(k.substring(0,3)));var h=parseInt(parseInt(k.substring(3,6)));for(var c=0;c<d;c++){var m=a[4+c];e.atoms[c]=new Atom(m.substring(31,34),parseFloat(m.substring(0,10))*default_bondLength,-parseFloat(m.substring(10,20))*default_bondLength,parseFloat(m.substring(20,30))*default_bondLength)}for(var c=0;c<h;c++){var m=a[4+d+c];var l=parseInt(m.substring(6,9));var g=parseInt(m.substring(9,12));if(l>3){switch(l){case 4:l=1.5;break;default:l=1;break}}var j=new Bond(e.atoms[parseInt(m.substring(0,3))-1],e.atoms[parseInt(m.substring(3,6))-1],l);switch(g){case 3:j.stereo=BOND_STEREO_AMBIGUOUS;break;case 1:j.stereo=BOND_STEREO_PROTRUDING;break;case 6:j.stereo=BOND_STEREO_RECESSED;break}e.bonds[c]=j}return e}function writeMOL(d){var h="Molecule from ChemDoodle Web Components\n\nhttp://www.ichemlabs.com\n";h=h+fit(d.atoms.length.toString(),3)+fit(d.bonds.length.toString(),3)+"  0  0  0  0            999 v2000\n";var j=d.getCenter();for(var g=0;g<d.atoms.length;g++){var e=d.atoms[g];h=h+fit(((e.x-j.x)/default_bondLength).toFixed(4),10)+fit((-(e.y-j.y)/default_bondLength).toFixed(4),10)+fit((e.z/default_bondLength).toFixed(4),10)+" "+fit(e.label,3)+" 0  0  0  0  0  0\n"}for(var g=0;g<d.bonds.length;g++){var c=d.bonds[g];var f=0;if(c.stereo==BOND_STEREO_AMBIGUOUS){f=3}else{if(c.stereo==BOND_STEREO_PROTRUDING){f=1}else{if(c.stereo==BOND_STEREO_RECESSED){f=6}}}h=h+fit((indexOf(d.atoms,c.a1)+1).toString(),3)+fit((indexOf(d.atoms,c.a2)+1).toString(),3)+fit(c.bondOrder.toString(),3)+"  "+f+"     0  0\n"}h=h+"M  END";return h}function fit(d,c){var b=d.length;var e="";for(var a=0;a<c-b;a++){e=e+" "}return e+d}function readPDB(e){var a=new Molecule();if(e==null||e.length==0){return a}var d=e.split("\n");var f=getPointsPerAngstrom();for(var c=0;c<d.length;c++){var b=d[c];if(b.indexOf("ATOM")==0||b.indexOf("HETATM")==0){a.atoms[a.atoms.length]=new Atom(b.substring(76,78),parseFloat(b.substring(30,38))*f,-parseFloat(b.substring(46,54))*f,parseFloat(b.substring(38,46)*f))}}deduceCovalentBonds(a);return a}function angleBetweenLargest(g){if(g.length==0){return 0}if(g.length==1){return g[0]+Math.PI}var e=0;var f=0;var a=-1;for(var c=0;c<g.length-1;c++){var b=g[c+1]-g[c];if(b>e){e=b;f=(g[c+1]+g[c])/2;a=c}}var d=g[0]+Math.PI*2-g[g.length-1];if(d>e){f=g[0]-d/2;e=d;if(f<0){f+=Math.PI*2}a=g.length-1}return f}function isBetween(a,c,b){return a>=c&&a<=b};